\section{Sensorenhet}
\emph{Det här avsnittet ska innehålla mera detaljerade blockscheman och beskrivningar av modulen.
Tänk på läsbarheten och växla mellan figurer och text.}

\subsection{Funktion}
Sensorenhetens uppgift är att samla in rådata från de olika sensorerna och formatera denna till användbar information. På begäran av andra delsystem skickar sensorenheten ut data via bussen. Sensorenheten är utrustad
med en linjesensor vars uppgift är att ge information om robotens befinnande i förhållande till tejplinjen. Informationen används som styrdata och skickas över bussen i form av en tyngdpunkt till chassimodulen för styrreglering.

Vidare är roboten bestyckad med två stycken sidoskannrar på vardera sida om den. Dessa används för att lokalisera objektet roboten ska plocka upp. Om ett föremål hittas räknar sensorenheten ut en koordinat för föremålet och skickar koordinaten över bussen till armenheten.

\subsection{Kopplingsschema}
\nyBild{kopplingsschema_sensor.png}{Kopplingsschema för sensorenheten}{senskoppling.}{0.6}

\subsection{Komponenter}
\begin{packed_itemize}
\item 1 x ATmega1284P, huvudprocessor
\item 1 x refelxsensormodul
\item 2 x 16-kanals multiplexrar
\item 1 x RFID-läsarer (Parallax Serial)
\item 2 x avståndssensorer (GP2D120)
\item 2 x resistorer (18~k\ohm), för lågpassfilter
\item 2 x kondensatorer (100~nF), för lågpassfilter
\end{packed_itemize}

\subsection{Sensorer}
Sensorenheten använder tre olika sensortyper: avståndssensor, linjesensor och RFID-läsare.
Dessa beskrivs kortfattat nedan. En djupare beskrivning av hur komponenterna fungerar finns i bilaga "sensorfördjupning"

\subsubsection{Avståndssensorer}
Avståndssensorerna används till robotens sidoskannrar. De mäter avstånd genom att skicka ut infrarött ljus som sedan reflekteras tillbaka i en PSD, Position Sensitive Detector. Avståndssensorerna som används fungerar för avstånd mellan \mbox{$4-30$ cm}. Eftersom de först mäter ett digitalt värde och sedan skickar ut en analog spänning uppstår brus på utsignalen. Detta brus är relativt högfrekvent varför det filtreras bort med hjälp av ett lågpassfilter innan signalen når processorn. Se kopplingsschema, figur \ref{senskoppling}.


En avläsning från en avståndssensor görs genom att omvandla sensorns analoga utspänning till ett digitalt värde. När A/D-omvandlingen är klar får sensorenheten ett avbrott där den jämför den A/D-omvanldade spänningen med en tabell över kända avstånd och spänningar för att översätta den till ett avstånd i millimeter. Värden som inte finns i tabellen beräknas med linjärinterpolering. 

Avståndssensorerna är någorlunda precisa i sina mätningar inom intervallet de är specificerade för. Men när en koordinat för ett föremål ska kalkyleras baserat på avståndssensorns uppmätta värden blir små avvikelser ännu mer kritiskt. Olika föremål och underlag kan få avståndssensorn att ge ut olika spänningar för samma avstånd. IR-ljuset som sänds ut har också en viss spridning men genom att montera avståndssensor i vertikalled minskar spridningspåverkan. Se figur \ref{fig:sidoskanner-montering}

\subsubsection{Linjesensor}
Reflexsensormodulen består av en uppsättning IR-dioder och fototransistorer för att mäta ljusheten hos underlaget. Eftersom reflexsensormodulen består av 11~stycken separata IR-dioder och fototransistorer används en multiplexer och en demultiplexer för att styra sensorn. Demultiplexern driver IR-dioderna och multiplexern används för att ta in insignalerna från fototransistorerna. Linjesensorn kommer att vara kopplad i enlighet med kopplingsschemat i figur \ref{fig:senskoppling}.

Reflexsensorn ger ut en analog spänning som är omvänt proportionell mot underlagets reflekterande ljusstyrka. En inläsning från linjesensorn sker genom ett funktionsanrop (via avbrott från A/D-omvandlaren) till linjesensorinläsningsfunktionen som finns på sensorenheten. När denna funktion anropas uppdateras en uppsättning variabler som är lagrade i en vektor. Vektorn är 11 element lång, där varje element representerar en reflexsensor.

När uppdateringen av linjesensorn startas för första gången är muxarna som styr linjesensorn inställda så att reflexsensorn längst till vänster väljs. Efter detta startas A/D-omvandling på kanal~0. När A/D-omvandlingen är färdig kommer ett avbrott (ADIF) att genereras vilket triggar en avbrottsrutin.

I denna avbrottsrutin skrivs det A/D-omvandlade värdet in på korrekt plats i linjesensorns datavektor. Denna plats motsvarar den valda linjesensorns position på sensormatrisen. Därefter upprepas samma process för nästkommande reflexsensor. Figur \ref{fig:senslinjeflöde} illustrerar processen för att uppdatera linjesensorns data.

\subsubsection{RFID-läsare}
Den RFID-läsare som kommer att användas är en “Parallax Serial”, denna kräver två pinnar på processorn enligt kopplingsschema i figur \ref{fig:senskoppling}.

\subsection{Sidoskanner}
Sidoskannerns uppgift är att hitta det objekt som ska plockas upp när roboten har stannat vid en plockstation. Sidoskannern består av två avståndssensorer, på höger-respektive vänster sida om roboten, monterade på varsitt servo. Servona styrs med snabb pulsbreddsmodulering. Servot får en puls var 20:e~millisekund och pulsbredden avgör vilket läge servot antar. En pulsbredd på ungefär 0.5~ms motsvarar servots ursprungsläge och en pulsbredd på ungefär 2.5~ms motsvarar max vinkelutslag. Detta varierar dock något från servo till servo.

För att få ett servot att svepa över robotens ena sida ökas pulsbredden inkrementellt med en stegkonstant motsvarande ett servoutslag på en grad. För varje iteration, dvs för varje vinkel servot står i, kommer avståndssensorn lägga in 20 stycken A/D-omvandlade avståndsmätningar i en array för att sedan ta medianvärdet av mätningarna. Slutligen omvandlas värdet till ett avstånd i millimeter med interpolationsfunktionen. Om avståndet är inom en zon, baserat på armens räckvidd, innebär det att att inget föremål detekterats och servots vinkel stegas upp ytterligare en grad. 

När avståndssensorn däremot påträffar ett föremål inom zonen sparas både vinkeln som servot står i och avståndet till föremålet undan innan sidoskannern stegar upp igen. För varje vinkel som avståndssensorerna fortfarande träffar föremålet sparas avståndet undan och slutligen även den sista vinkeln då den fortfarande träffade ett föremål.

En medelvinkel av den första och sista vinkeln räknas ut och ett medianvärde för avståndet till föremålet. Medelvinkeln $\alpha$ och medianavståndet $L$ används sedan för att räkna ut en vinkel $\beta$ och ett avstånd, $R$, för armen till föremålet innan dessa skickas tillbaka till armenheten. Se figur \ref{fig:sidoskanner}
\nyBild{sidoskanner.png}{Vänster sidoskanner.}{sidoskanner}{0.7}

\subsection{Översiktlig beskrivning av programmet}

\subsubsection{Inläsning från avståndssensorer}







